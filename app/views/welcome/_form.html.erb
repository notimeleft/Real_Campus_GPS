<html lang="en" style="height: 100%">

<script src="//maps.google.com/maps/api/js?v=3.22&libraries=geometry" type="text/javascript"></script>
<script src="//google-maps-utility-library-v3.googlecode.com/svn/tags/markerclustererplus/2.0.14/src/markerclusterer_packed.js" type="text/javascript"></script>

<body style="height: 100%; margin: 0">

  <div style='width: 100%; height: 100%;'>
    <div id="map" style='width: 100%; height: 100%;'></div>
  </div>

  <script type="text/javascript">
    function animateCircle(line) {
      var count = 0;
      window.setInterval(function() {
        count = (count + 1) % 200;

        var icons = line.get('icons');
        icons[0].offset = (count / 2) + '%';
        line.set('icons', icons);
      }, 20);
    };
    var anumber = 1;
    var southWest = new google.maps.LatLng( 42.358631, -71.277989 );
    var northEast = new google.maps.LatLng( 42.373986, -71.243614 );
    var hyderabadBounds = new google.maps.LatLngBounds( southWest, northEast );
    var mapOptions = {
      center: new google.maps.LatLng(42.366426, -71.258601),
      maxZoom:18,
      minZoom:16,
      maxBounds: hyderabadBounds
      //scrollwheel: false,
      //zoomControl: false
    };
    var markers = [];
    var plan = <%= raw @result %>;
    var listOfCoordinates = []
    for (i = 0; i < plan.length; i++) {
      listOfCoordinates.push(new google.maps.LatLng(plan[i][0], plan[i][1]));
    }

    function drop() {
      clearMarkers();
      for (var i = 0; i < listOfCoordinates.length; i++) {
        addMarkerWithTimeout(listOfCoordinates[i], i * 200);
      }
    }
    function addMarkerWithTimeout(position, timeout) {
      window.setTimeout(function() {
        markers.push(new google.maps.Marker({
          position: position,
          map: handler.getMap(),
          animation: google.maps.Animation.DROP
        }));
      }, timeout);
    }
    function clearMarkers() {
      for (var i = 0; i < markers.length; i++) {
        markers[i].setMap(null);
      }
      markers = [];
    }

    function drawLine(plan, listOfCoordinates){
      var lineSymbol = {
        path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
        scale: 4,
        strokeColor: '#393',
        fillColor: '#00FF00',
        fillOpacity: 1.0,
      };
      var line = new google.maps.Polyline({
        path: listOfCoordinates,
        strokeColor: '#006400',
        strokeOpacity: 0.5,
        icons: [{
          icon: lineSymbol,
          offset: '100%'
        }],
        map: handler.getMap()
      });
      if(plan.length > 1){
        var infowindow =  new google.maps.InfoWindow({
   	     content: 'Destination',
   	     map: handler.getMap()
        });
        var infowindow_start =  new google.maps.InfoWindow({
   	     content: 'Start',
   	     map: handler.getMap()
        });
        var image_end = 'https://developers.google.com/maps/documentation/javascript/examples/full/images/beachflag.png';
        var image_start = 'https://mt.googleapis.com/vt/icon/name=icons/onion/22-blue-dot.png&scale=1.0';
        var start_point = new google.maps.Marker({
          position: listOfCoordinates[0],
          map: handler.getMap(),
          icon: image_start,
          animation: google.maps.Animation.DROP
        });
        var final_point = new google.maps.Marker({
          position: listOfCoordinates[plan.length-1],
          map: handler.getMap(),
          icon: image_end,
          animation: google.maps.Animation.DROP
        });
        infowindow_start.open(handler.getMap(), start_point);
        infowindow.open(handler.getMap(), final_point);
      }
      animateCircle(line);
    };

     var handler = Gmaps.build('Google');
     handler.buildMap({ provider: mapOptions, internal: {id: 'map'}}, function(){
       //drop();
       drawLine(plan, listOfCoordinates);

       if(navigator.geolocation)
          navigator.geolocation.getCurrentPosition(displayOnMap,function error(msg){alert('Please enable your GPS position future.');
          }, {maximumAge:600000, timeout:8000, enableHighAccuracy: true});

       handler.fitMapToBounds();
     });

      google.maps.event.addListener(handler.getMap(), 'dragend',  function( evt ) {
        if (hyderabadBounds.contains(handler.getMap().getCenter())) return;
        handler.map.centerOn(new google.maps.LatLng(42.366426, -71.258601));
          //alert("hello!");
      });

     function displayOnMap(position){
       var lat = position.coords.latitude;
       var lng = position.coords.longitude;
       var infowindow =  new google.maps.InfoWindow({
  	     content: 'You are here!',
  	     map: handler.getMap()
       });
       var marker = new google.maps.Marker({
         position: new google.maps.LatLng(lat, lng),
         map: handler.getMap(),
         animation: google.maps.Animation.DROP
       });
       infowindow.open(handler.getMap(), marker);//marker.serviceObject
       //handler.map.centerOn(marker);
     };

  </script>
</body>
</html>
